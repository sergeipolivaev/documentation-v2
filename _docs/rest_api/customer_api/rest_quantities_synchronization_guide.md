---
title: Получение актуальных остатков при первой синхронизации ТУ и Облака Эвотор
permalink: rest_quantities_synchronization_guide.html
sidebar: evorestguides
product: Customer API
---

Когда пользователь впервые устанавливает товароучётную систему (далее также *ТУ*) это может привести к нарушению количества или обнулению остатков товаров. Такое поведение ТУ можно объяснить неочевидным способом получения остатков, актуальных на момент установки приложения.

В основе получения актуальных остатков лежит обработка остатков, указанных в поле (`initial_quantity`V2, посмотреть V1) различных видов документов. В зависимости от значения поля и типа документа (например, продажа или возврат товара), следует выполнить определённую обработку остатков.

В этой статье приводится один из возможных способов обработки документов и получения актуальных остатков.

*Чтобы получить актуальные остатки:*

1. Узнайте список магазинов пользователя с помощью метода [`GET /stores`](./rest_stores.html#получить-список-магазинов).

   Одному магазину может соответствовать множество смарт-терминалов, поэтому товарная номенклатура и учёт остатков, ведутся в контексте магазина.

2. Получите номенклатуру каждого из магазинов пользователя с помощью метода [`GET /stores/{store-id}/products`](./rest_products.html#получить-все-товары).

   Если пользователь впервые устанавливает ТУ, остатки всех товаров будут нулевыми.

3. Получите список всех документов магазина за выбранный вами период (например, шесть месяцев) с помощью метода [`GET /stores/{store-id}/documents`](./rest_documents.html#получить-список-документов).

   Максимальный период выборки документов зависит от версии API, которую вы используете: один год для API V1 или всё время с момента создания магазина для API V2. Дату создания магазина вы можете определить по первым восьми символам его идентификатора (`id`).

   {% include tip.html content="Получение большого количества документов может быть ресурсоёмким. Чтобы упростить эту задачу вы можете выполнять запросы по месяцу. Вам также нет необходимости запрашивать документы, которые были созданы ранее последнего [документа инвентаризации (тип `INVENTORY)`](./rest_inventory.html), который содержит актуальные остатки на определённую дату." %}

4. Теперь, когда вы знаете идентификаторы всех товаров (поле `uuid` в API V1 или `id` в API V2) и документов, необходимо найти самый новый документ, соответствующий каждому из товаров. В зависимости от типа документа реализуйте следующую логику:

   * Если последним документом по товару был [документ приёмки (тип `ACCEPT`)](./rest_accept.html), используйте указанные в нём остатки товара.
   * Если последним документом по товару был [документ продажи (тип `SELL`)](./rest_sell.html), из указанных в нём остатков необходимо вычесть количество проданного товара.

   {% include note.html content="При обработке документов продажи, обращайте внимание на тип признака способа расчёта (поле `settlement_method.type`). Остаток товара изменяется только в тех случаях, когда это поле содержит одно из значений: `CHECKOUT_FULL`, `CHECKOUT_PARTIAL`, `CREDIT_PASS` или `CREDIT_CHECKOUT`." %}

   * Если последним документом по товару был [документ возврата (тип `PAYBACK`)](./rest_payback.html), к указанным в нём остаткам необходимо добавить количество возвращённого товара.

   Полученные таким образом остатки запишите в поле `quantity` соответствующих товаров.

   Если за выбранный вами период документов по товару не обнаружено, оставьте товар без изменений и продолжайте в фоновом режиме запрашивать более старые документы.

   {% include tip.html content="Вы также можете сообщить пользователю по каким товарам не удалось получить актуальные остатки и рекомендовать ему указать их вручную." %}

5. В зависимости от версии API, которую вы используете:

   * Если вы используете API V2, обновите остатки в Облаке Эвотор с помощью метода [`PATCH /stores/{store-id}/products/{product-id}`](./rest_products.html#обновить-остатки-товара).
   * Если вы используете API V1, перезапишите товары с актуальными остатками в Облаке Эвотор с помощью метода [`POST /inventories/stores/{storeUuid}/products`](https://api.evotor.ru/docs/#tag/Tovary-i-dokumenty%2Fpaths%2F~1api.evotor.ru~1api~1v1~1inventories~1stores~1%7BstoreUuid%7D~1products%2Fpost).

Остатки товаров обновлены. Теперь вы можете сообщить своим пользователям, что в Облаке Эвотор доступны новые данные, которые можно загрузить на смарт-терминалы.
